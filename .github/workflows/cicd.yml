name: Java CI/CD with Gradle and SonarCloud

on:
  push:
    branches: [ "main", "develop" ]
  pull_request:
    branches: [ "main" ]

jobs:
  CI:
    runs-on: ubuntu-latest
    permissions:
      contents: read

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # SonarCloudì—ì„œ ì „ì²´ íˆìŠ¤í† ë¦¬ í•„ìš”

      # .gitignoreì— ìˆëŠ” propertiesíŒŒì¼ ì¶”ê°€
      - name: Add prod_properties
        run: |
          mkdir -p ./src/main/resources
          mkdir -p ./src/main/resources/firebase
          touch ./src/main/resources/application.properties
          touch ./src/main/resources/firebase/firebase_service_key.json
          echo "${{ secrets.PROPERTIES }}" > ./src/main/resources/application.properties
          echo '${{ secrets.FIREBASE_JSON }}' > ./src/main/resources/firebase/firebase_service_key.json

      - name: Set up JDK 21
        uses: actions/setup-java@v4
        with:
          java-version: '21'  # í”„ë¡œì íŠ¸ì— ë§ì¶° 21ë¡œ ë³€ê²½
          distribution: 'temurin'

      # SonarCloud íŒ¨í‚¤ì§€ ìºì‹œ
      - name: Cache SonarCloud packages
        uses: actions/cache@v3
        with:
          path: ~/.sonar/cache
          key: ${{ runner.os }}-sonar
          restore-keys: ${{ runner.os }}-sonar

      # Gradle ìºì‹œ
      - name: Cache Gradle packages
        uses: actions/cache@v3
        with:
          path: ~/.gradle/caches
          key: ${{ runner.os }}-gradle-${{ hashFiles('**/*.gradle') }}
          restore-keys: ${{ runner.os }}-gradle

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@af1da67850ed9a4cedd57bfd976089dd991e2582 # v4.0.0

      - name: Grant execute permission for gradlew
        run: chmod +x gradlew

      # 1ë‹¨ê³„: í…ŒìŠ¤íŠ¸ ë° ì»¤ë²„ë¦¬ì§€ ìƒì„± (ì‹¤íŒ¨í•´ë„ ê³„ì† ì§„í–‰)
      - name: Run tests and generate coverage
        run: ./gradlew clean test jacocoTestReport --continue
        continue-on-error: true  # í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ SonarCloud ë¶„ì„ì€ ì§„í–‰

      # 2ë‹¨ê³„: SonarCloud ë¶„ì„ ì‹¤í–‰
      - name: Analyze with SonarCloud
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          SONAR_TOKEN: ${{ secrets.SONAR_TOKEN }}
        run: |
          # ë””ë²„ê¹…ì„ ìœ„í•œ ì •ë³´ ì¶œë ¥
          echo "SONAR_PROJECT_KEY: ${{ secrets.SONAR_PROJECT_KEY }}"
          echo "SONAR_ORGANIZATION: ${{ secrets.SONAR_ORGANIZATION }}"
          
          ./gradlew sonar \
          -Dsonar.projectKey=${{ secrets.SONAR_PROJECT_KEY }} \
          -Dsonar.organization=${{ secrets.SONAR_ORGANIZATION }} \
          -Dsonar.host.url=https://sonarcloud.io \
          -Dsonar.token=${{ secrets.SONAR_TOKEN }} \
          -Dsonar.gradle.skipCompile=true \
            -Dsonar.qualitygate.wait=false \
            --info --stacktrace
        continue-on-error: true

      # 3ë‹¨ê³„: ë¹Œë“œ (í…ŒìŠ¤íŠ¸ ì œì™¸)
      - name: Build with Gradle Wrapper
        run: ./gradlew build --exclude-task test

      # 4ë‹¨ê³„: í’ˆì§ˆ ë¦¬í¬íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      - name: Upload quality reports
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: quality-reports-${{ github.run_number }}
          path: |
            build/reports/tests/test/
            build/jacocoReport/test/html/
          retention-days: 30

      # 5ë‹¨ê³„: PRì— í’ˆì§ˆ ë¦¬í¬íŠ¸ ì½”ë©˜íŠ¸ ì¶”ê°€
      - name: Comment PR with quality results
        if: github.event_name == 'pull_request'
        uses: actions/github-script@v6
        with:
          script: |
            const projectKey = '${{ secrets.SONAR_PROJECT_KEY }}';
            const organization = '${{ secrets.SONAR_ORGANIZATION }}';
            const sonarUrl = `https://sonarcloud.io/project/overview?id=${projectKey}`;
            const runNumber = '${{ github.run_number }}';
            
            const comment = `
            ## ğŸ” ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ê²°ê³¼ (Build #${runNumber})
            
            ### ğŸ“Š SonarCloud ë¶„ì„
            ğŸ”— **[SonarCloud ëŒ€ì‹œë³´ë“œì—ì„œ ìƒì„¸ ê²°ê³¼ í™•ì¸](${sonarUrl})**
            
            ### ğŸ“ˆ ì£¼ìš” ì²´í¬ í•­ëª©
            - âœ… ì •ì  ì½”ë“œ ë¶„ì„ ì™„ë£Œ
            - âœ… ì½”ë“œ ì»¤ë²„ë¦¬ì§€ ì¸¡ì • ì™„ë£Œ
            - âœ… ë³´ì•ˆ ì·¨ì•½ì  ìŠ¤ìº” ì™„ë£Œ
            - âœ… ì½”ë“œ ë³µì¡ë„ ë¶„ì„ ì™„ë£Œ
            
            ### ğŸ“‹ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ
            - [í…ŒìŠ¤íŠ¸ & ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ ë‹¤ìš´ë¡œë“œ](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})
            
            > ğŸ’¡ **ì°¸ê³ **: "Previous version" ì„¤ì •ìœ¼ë¡œ ìƒˆë¡œ ë³€ê²½ëœ ì½”ë“œë§Œ ì—„ê²©í•˜ê²Œ ê²€ì‚¬ë©ë‹ˆë‹¤.
            
            ---
            ğŸ¤– ìë™ ìƒì„±ëœ í’ˆì§ˆ ë¦¬í¬íŠ¸ | SonarCloud Integration
            `;
            
            if (context.issue.number) {
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: comment
              });
            }

      # 6ë‹¨ê³„: Docker Image Build and Push (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKERHUB_USERNAME }}
          password: ${{ secrets.DOCKERHUB_TOKEN }}

      - name: Set up Docker Build
        uses: docker/setup-buildx-action@v3

      - name: Build and push Docker image
        uses: docker/build-push-action@v6
        with:
          context: .
          file: ./Dockerfile
          push: true
          tags: |
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:latest
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:build-${{ github.run_number }}
            ${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}:${{ github.sha }}

      # 7ë‹¨ê³„: CD ë°°í¬ (ê¸°ì¡´ ë¡œì§ ìœ ì§€)
      - name: Deploy to production server
        uses: appleboy/ssh-action@master
        with:
          host: ${{ secrets.DEPLOYMENT_HOST }}
          username: ${{ secrets.DEPLOYMENT_USERNAME }}
          key: ${{ secrets.SSH_KEY }}
          script_stop: true
          script: |
            cd neeis
            chmod +x ./deploy.sh
            ./deploy.sh
            echo "ğŸš€ ë°°í¬ ì™„ë£Œ: $(date '+%Y-%m-%d %H:%M:%S')"

      # 8ë‹¨ê³„: ë°°í¬ ì„±ê³µ ì•Œë¦¼ (ì„ íƒì‚¬í•­)
      - name: Notify deployment success
        if: success()
        run: |
          echo "âœ… ì „ì²´ CI/CD íŒŒì´í”„ë¼ì¸ ì„±ê³µ!"
          echo "ğŸ“Š SonarCloud: https://sonarcloud.io/project/overview?id=${{ secrets.SONAR_PROJECT_KEY }}"
          echo "ğŸ³ Docker Hub: https://hub.docker.com/r/${{ secrets.DOCKERHUB_USERNAME }}/${{ secrets.DOCKERHUB_REPONAME }}"
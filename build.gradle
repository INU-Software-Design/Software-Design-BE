// Gradle ê²½ê³  ë©”ì‹œì§€ ì™„ì „ í•´ê²° ë²„ì „

plugins {
    id 'java'
    id 'org.springframework.boot' version '3.3.6'
    id 'io.spring.dependency-management' version '1.1.7'
    id 'jacoco'
    id 'org.sonarqube' version '4.4.1.3373'
}

group = 'com.neeis'
version = '0.0.1-SNAPSHOT'

java {
    toolchain {
        languageVersion = JavaLanguageVersion.of(21)
    }
}

configurations {
    compileOnly {
        extendsFrom annotationProcessor
    }
}

repositories {
    mavenCentral()
}

// Gradle Wrapper ì„¤ì •
wrapper {
    gradleVersion = '8.8'
    distributionType = Wrapper.DistributionType.ALL
}

jacoco {
    toolVersion = "0.8.11"
    reportsDirectory = layout.buildDirectory.dir('jacocoReport')
}

// SonarQube ì„¤ì • (ëª¨ë“  ê²½ê³  í•´ê²°)
sonar {
    properties {
        property "sonar.projectKey", "neeis-project"
        property "sonar.projectName", "NEEIS Project"
        property "sonar.host.url", "http://localhost:9000"

        // ì»´íŒŒì¼ skip ì„¤ì • (ê²½ê³  í•´ê²°)
        property "sonar.gradle.skipCompile", "true"

        // ì†ŒìŠ¤ ì½”ë“œ ê²½ë¡œ ì„¤ì •
        property "sonar.sources", "src/main/java"
        property "sonar.tests", "src/test/java"

        // ìµœì‹  ê²½ë¡œ API ì‚¬ìš©
        property "sonar.coverage.jacoco.xmlReportPaths",
                layout.buildDirectory.file("jacocoReport/test/jacocoTestReport.xml").get().asFile.absolutePath

        property "sonar.junit.reportPaths",
                layout.buildDirectory.dir("test-results/test").get().asFile.absolutePath

        property "sonar.java.binaries",
                layout.buildDirectory.dir("classes/java/main").get().asFile.absolutePath

        property "sonar.java.test.binaries",
                layout.buildDirectory.dir("classes/java/test").get().asFile.absolutePath

        // ì œì™¸ íŒ¨í„´
        property "sonar.exclusions", [
                "**/dto/**/*",
                "**/global/common/**/*",
                "**/*Application.java",
                "**/exception/**/*",
                "**/config/**/*",
                "**/Q*.java",
                "**/report/**/*",
                "**/fcm/**/*",
                "**/notification/**/*"
        ].join(",")

        property "sonar.coverage.exclusions", [
                "**/dto/**/*",
                "**/global/common/**/*",
                "**/*Application.java",
                "**/exception/**/*",
                "**/config/**/*",
                "**/Q*.java",
                "**/report/**/*",
                "**/fcm/**/*",
                "**/notification/**/*"
        ].join(",")

        // Quality Gate ì„¤ì •
        property "sonar.qualitygate.wait", "false"

        // ì–¸ì–´ ë° ì¸ì½”ë”©
        property "sonar.java.source", "21"
        property "sonar.sourceEncoding", "UTF-8"
    }
}

// ì˜ì¡´ì„±ì€ ë™ì¼...
dependencies {
    implementation 'org.springframework.boot:spring-boot-starter-data-jpa'
    implementation 'org.springframework.boot:spring-boot-starter-web'
    implementation 'org.thymeleaf.extras:thymeleaf-extras-springsecurity6'
    compileOnly 'org.projectlombok:lombok'
    runtimeOnly 'com.mysql:mysql-connector-j'
    annotationProcessor 'org.projectlombok:lombok'
    testImplementation 'org.springframework.boot:spring-boot-starter-test'
    testRuntimeOnly 'org.junit.platform:junit-platform-launcher'
    implementation 'org.springframework.retry:spring-retry'
    implementation 'org.springdoc:springdoc-openapi-starter-webmvc-ui:2.2.0'
    implementation 'org.springframework.boot:spring-boot-starter-validation'
    implementation 'org.springframework.boot:spring-boot-starter-security'
    implementation 'org.springframework.security:spring-security-test'
    implementation 'io.jsonwebtoken:jjwt-api:0.11.5'
    implementation 'io.jsonwebtoken:jjwt-impl:0.11.5'
    implementation 'io.jsonwebtoken:jjwt-jackson:0.11.5'
    implementation 'org.springframework.boot:spring-boot-starter-actuator'
    implementation 'io.micrometer:micrometer-registry-prometheus'
    implementation 'com.google.firebase:firebase-admin:9.4.3'
    implementation 'org.apache.poi:poi:5.2.5'
    implementation 'org.apache.poi:poi-ooxml:5.2.5'
    implementation 'org.springframework.boot:spring-boot-starter-thymeleaf'
    implementation 'com.itextpdf:layout:7.2.5'
    implementation 'com.itextpdf:kernel:7.2.5'
    implementation 'com.itextpdf:io:7.2.5'
    implementation 'com.itextpdf:font-asian:7.2.5'
}

// í…ŒìŠ¤íŠ¸ ì„¤ì • (ìµœì‹  API ì‚¬ìš©)
tasks.named('test') {
    useJUnitPlatform()
    finalizedBy tasks.jacocoTestReport

    // í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨í•´ë„ ë¦¬í¬íŠ¸ëŠ” ìƒì„±
    ignoreFailures = true

    // í…ŒìŠ¤íŠ¸ ê²°ê³¼ XML ìƒì„±
    reports {
        junitXml.required = true
        html.required = true
    }

    systemProperty 'file.encoding', 'UTF-8'
}

// JaCoCo ë¦¬í¬íŠ¸ (ìµœì‹  API ì‚¬ìš© - afterEvaluate ë¬¸ì œ í•´ê²°)
tasks.named('jacocoTestReport') {
    dependsOn tasks.test

    reports {
        xml.required = true
        csv.required = false
        html.required = true
    }

    finalizedBy tasks.jacocoTestCoverageVerification
}

// JaCoCo ì œì™¸ íŒ¨í„´ì„ ë³„ë„ë¡œ ì„¤ì • (afterEvaluate ëŒ€ì‹ )
afterEvaluate {
    tasks.jacocoTestReport {
        def excludePatterns = [
                '**/dto/**',
                '**/config/**',
                '**/global/common/**',
                '**/*Application*',
                '**/exception/**',
                '**/Q*',
                '**/report/**',
                '**/fcm/**',
                '**/notification/**',
                '**/domain/**/entity/**',
                '**/event/**'
        ]

        classDirectories.setFrom(files(classDirectories.files.collect {
            fileTree(dir: it, exclude: excludePatterns)
        }))
    }
}

// ì»¤ë²„ë¦¬ì§€ ê²€ì¦ (í˜„ì‹¤ì  ê¸°ì¤€)
tasks.named('jacocoTestCoverageVerification') {
    violationRules {
        rule {
            enabled = true
            element = 'CLASS'

            limit {
                counter = 'LINE'
                value = 'COVEREDRATIO'
                minimum = 0.00
            }

            limit {
                counter = 'BRANCH'
                value = 'COVEREDRATIO'
                minimum = 0.00
            }

            excludes = [
                    '**/domain/**/dto/**',
                    '**/config/**',
                    '**/global/report/**',
                    '**/global/common/**',
                    '**.*Application*',
                    '**/exception/**',
                    '**/Q*',
                    '**/report/**',
                    '**/fcm/**',
                    '**/notification/**',
                    '**/domain/**/entity/**',
                    '**/event/**'
            ]
        }
    }
}

// SonarQube íƒœìŠ¤í¬ ì˜ì¡´ì„± ì„¤ì • (ìµœì‹  API)
tasks.named('sonar') {
    dependsOn tasks.compileJava, tasks.compileTestJava, tasks.test, tasks.jacocoTestReport
}

// ì»¤ìŠ¤í…€ íƒœìŠ¤í¬ë“¤ (ìµœì‹  Task API ì‚¬ìš©)
tasks.register('testOnly') {
    group = 'verification'
    description = "í…ŒìŠ¤íŠ¸ë§Œ ì‹¤í–‰ (ì‹¤íŒ¨ ë¬´ì‹œ)"
    dependsOn tasks.test

    doLast {
        def testResultsDir = layout.buildDirectory.dir("test-results/test").get().asFile
        if (testResultsDir.exists()) {
            def reportPath = layout.buildDirectory.file("reports/tests/test/index.html").get().asFile
            println "ğŸ“Š í…ŒìŠ¤íŠ¸ ê²°ê³¼: ${reportPath.absolutePath}"
        }
    }
}

tasks.register('coverageOnly') {
    group = 'verification'
    description = "ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸ë§Œ ìƒì„±"
    dependsOn tasks.test, tasks.jacocoTestReport

    doLast {
        def reportPath = layout.buildDirectory.file("jacocoReport/test/html/index.html").get().asFile
        println "ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: ${reportPath.absolutePath}"
    }
}

tasks.register('coverageCheck') {
    group = 'verification'
    description = "ì»¤ë²„ë¦¬ì§€ ê¸°ì¤€ ì²´í¬"
    dependsOn tasks.test, tasks.jacocoTestReport, tasks.jacocoTestCoverageVerification
}

tasks.register('sonarAnalysis') {
    group = 'verification'
    description = "SonarQube ë¶„ì„ ì‹¤í–‰"
    dependsOn tasks.compileJava, tasks.compileTestJava, tasks.test, tasks.jacocoTestReport, tasks.sonar
}

tasks.register('qualityReport') {
    group = 'verification'
    description = "í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„± (ì‹¤íŒ¨ ë¬´ì‹œ)"

    dependsOn tasks.testOnly, tasks.coverageOnly

    doFirst {
        println "ğŸ” í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„± ì‹œì‘..."
    }

    doLast {
        def buildDir = layout.buildDirectory.get().asFile
        println ""
        println "ğŸ“‹ í’ˆì§ˆ ë¦¬í¬íŠ¸ ìƒì„± ì™„ë£Œ!"
        println "=" * 50
        println "ğŸ“Š í…ŒìŠ¤íŠ¸ ë¦¬í¬íŠ¸: ${buildDir}/reports/tests/test/index.html"
        println "ğŸ“ˆ ì»¤ë²„ë¦¬ì§€ ë¦¬í¬íŠ¸: ${buildDir}/jacocoReport/test/html/index.html"
        println "ğŸ” SonarQube ëŒ€ì‹œë³´ë“œ: http://localhost:9000"
        println ""
        println "ğŸ’¡ ë‹¤ìŒ ë‹¨ê³„:"
        println "  1. ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸ ìˆ˜ì •: ./gradlew test"
        println "  2. ì»¤ë²„ë¦¬ì§€ í–¥ìƒ: ./gradlew coverageCheck"
        println "  3. SonarQube ë¶„ì„: ./gradlew sonarAnalysis"
    }
}

tasks.register('deploymentCheck') {
    group = 'verification'
    description = "ë°°í¬ ì „ í’ˆì§ˆ ê²€ì‚¬ (ì—„ê²©í•œ ê¸°ì¤€)"

    dependsOn tasks.test, tasks.jacocoTestReport

    doFirst {
        println "ğŸš€ ë°°í¬ ì „ í’ˆì§ˆ ê²€ì‚¬ ì‹œì‘..."
    }

    doLast {
        def testResultsDir = layout.buildDirectory.dir("test-results/test").get().asFile

        if (!testResultsDir.exists()) {
            throw new GradleException("âŒ í…ŒìŠ¤íŠ¸ ê²°ê³¼ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!")
        }

        def failedTests = fileTree(testResultsDir).matching {
            include "**/*.xml"
        }.collect { file ->
            def xml = new XmlSlurper().parse(file)
            return xml.@failures.toInteger() + xml.@errors.toInteger()
        }.sum()

        if (failedTests > 0) {
            throw new GradleException("âŒ í…ŒìŠ¤íŠ¸ ì‹¤íŒ¨ë¡œ ë°°í¬ ì¤‘ë‹¨! ì‹¤íŒ¨í•œ í…ŒìŠ¤íŠ¸: ${failedTests}ê°œ")
        }

        println "âœ… ë°°í¬ í’ˆì§ˆ ê²€ì‚¬ í†µê³¼!"
    }
}